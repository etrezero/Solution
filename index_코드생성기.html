<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìì—°ì–´ â†’ íŒŒì´ì¬ ì‹¤í–‰ê¸°</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 20px; background: #f9f9f9; display: flex; justify-content: center; }
    .container { width: 90%; max-width: 800px; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    textarea { width: 100%; height: 100px; font-size: 16px; padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
    button { padding: 12px 16px; font-size: 16px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background: #0056b3; }
    .section { margin-top: 30px; }
    pre, .html-output { background: #f1f1f1; padding: 10px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; }
    #loading { display: none; text-align: center; margin-top: 20px; }
    .spinner { margin: auto; border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 36px; height: 36px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* ëª¨ë‹¬ */
    #errorModal {
      display: none;
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translate(-50%, -20%);
      background: white;
      border: 1px solid #ccc;
      padding: 20px;
      z-index: 1000;
      width: 80%;
      max-width: 600px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    #errorModal button {
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ìì—°ì–´ â†’ íŒŒì´ì¬ ì½”ë“œ ì‹¤í–‰ê¸°<br>*Covenant*</h1>
    
    <textarea 
    id="command" 
    placeholder=
    "ì˜ˆ: ëŒ€í•œë¯¼êµ­ ì¸êµ¬ì¶”ì´ë¥¼ ê·¸ë˜í”„ë¡œ ì‘ì„±í•´ì¤˜ <br>
ì˜ˆ: ëŒ€í•œë¯¼êµ­ 3ë…„ë§Œê¸° êµ­ì±„ê¸ˆë¦¬ ì¶”ì´ë¥¼ ê·¸ë˜í”„ë¡œ ì‘ì„±í•´ì¤˜ <br>
ì˜ˆ: ë¯¸êµ­ S&P500 ì£¼ê°€ ì¶”ì´ë¥¼ ê·¸ë˜í”„ë¡œ ì‘ì„±í•´ì¤˜ <br>
    ">

ëŒ€í•œë¯¼êµ­ ì¸êµ¬ì¶”ì´ë¥¼ ê·¸ë˜í”„ë¡œ ì‘ì„±í•´ì¤˜
    </textarea>


    <button id="run-btn" onclick="runCommand()">ì‹¤í–‰</button>

    <div id="loading">
      <div class="spinner"></div>
      <p>GPT ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>

    <div class="section">
      <h3>ğŸ“„ Code ìƒì„±</h3>
      <div id="output" class="html-output"></div>
    </div>
    <div class="section">
      <h3>ğŸ¥¹ Code ì‹¤í–‰ ê²°ê³¼</h3>
      <div id="rendered_cleaned_code" class="html-output dash-container" onclick="showRenderedCleanedCode()"></div>
    </div>
  </div>

  <!-- ğŸ“Œ ì˜¤ë¥˜ íŒì—… ëª¨ë‹¬ -->
  <div id="errorModal">
    <h3>ğŸš¨ ì˜¤ë¥˜ ë°œìƒ</h3>
    <pre id="errorText"></pre>
    <button onclick="copyErrorText()">ğŸ“‹ ë³µì‚¬</button>
    <button onclick="document.getElementById('errorModal').style.display='none'">ë‹«ê¸°</button>
  </div>

  <script>
    async function runCommand() {
      document.getElementById("loading").style.display = "block";
      const runBtn = document.getElementById("run-btn");
      runBtn.disabled = true;
      runBtn.textContent = "ì‹¤í–‰ ì¤‘...";

      const command = document.getElementById("command").value;
      try {
        const res = await fetch("/run", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ command })
        });
        const data = await res.json();

        const renderedCodeEl = document.getElementById("rendered_cleaned_code");
        const outputEl = document.getElementById("output");


        
        if (data.error) {
          showErrorPopup(data.error);
          renderedCodeEl.innerHTML = `<pre>${data.cleaned_code || ''}</pre>`;
          outputEl.innerHTML = "";
        } else {
          if (data.output.startsWith("/rendered/")) {
            renderedCodeEl.innerHTML = `<iframe src="${data.output}" width="100%" height="400" style="border:none;"></iframe>`;
          } else {
            renderedCodeEl.innerHTML = `<p>HTML íŒŒì¼ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>`;
          }
          outputEl.innerHTML = `<pre>${data.cleaned_code || ''}</pre>`;
        }
      } catch (err) {
        showErrorPopup("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: " + err.message);
      } finally {
        document.getElementById("loading").style.display = "none";
        runBtn.disabled = false;
        runBtn.textContent = "ì‹¤í–‰";
      }
    }


    function showRenderedCleanedCode() {
      const iframe = document.querySelector('#rendered_cleaned_code iframe');
      if (iframe) window.open(iframe.src, '_blank');
    }

    function showErrorPopup(message) {
      document.getElementById("errorText").textContent = message;
      document.getElementById("errorModal").style.display = "block";
    }


  function copyErrorText() {
    const textEl = document.getElementById("errorText");
    const textToCopy = textEl.textContent;
    const copyBtn = document.querySelector("#errorModal button");

    // í…ìŠ¤íŠ¸ ì„ íƒ
    const range = document.createRange();
    range.selectNodeContents(textEl);
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);

    // âœ… navigator.clipboard ì§€ì› ì‹œ ì‚¬ìš©
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(textToCopy).then(() => {
        copyBtn.textContent = "âœ… ë³µì‚¬ë¨";
        setTimeout(() => {
          copyBtn.textContent = "ğŸ“‹ ë³µì‚¬";
        }, 1500);
      }).catch((err) => {
        fallbackCopy(textToCopy, copyBtn);
      });
    } else {
      // â— fallback (êµ¬ë²„ì „ ë¸Œë¼ìš°ì € ì§€ì›)
      fallbackCopy(textToCopy, copyBtn);
    }
  }

  function fallbackCopy(text, copyBtn) {
    try {
      const textarea = document.createElement("textarea");
      textarea.value = text;
      textarea.setAttribute("readonly", "");
      textarea.style.position = "absolute";
      textarea.style.left = "-9999px";
      document.body.appendChild(textarea);
      textarea.select();

      const successful = document.execCommand("copy");
      document.body.removeChild(textarea);

      if (successful) {
        copyBtn.textContent = "âœ… ë³µì‚¬ë¨";
        setTimeout(() => {
          copyBtn.textContent = "ğŸ“‹ ë³µì‚¬";
        }, 1500);
      } else {
        alert("âŒ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      }
    } catch (err) {
      alert("âŒ ë³µì‚¬ ì˜¤ë¥˜: " + err.message);
    }
  }




  </script>
</body>
</html>
